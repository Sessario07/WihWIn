name: CI - Unit Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  fastapi-tests:
    name: FastAPI Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: FastAPI_backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: FastAPI_backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff httpx

      - name: Lint with Ruff
        run: |
          ruff check . --select=E,F,W --ignore=E501,F401 --exit-zero

      - name: Run FastAPI unit tests
        run: |
          pytest tests/ -v --tb=short -x


  worker-tests:
    name: Worker Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Worker

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: Worker/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff

      - name: Lint with Ruff
        run: |
          ruff check . --select=E,F,W --ignore=E501,F401 --exit-zero

      - name: Run Worker unit tests
        run: |
          pytest tests/ -v --tb=short -x

  spring-boot-tests:
    name: Spring Boot Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Spring_Backend/wihwin

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Spring Boot unit tests
        run: |
          ./mvnw test -B -q --fail-fast


  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [fastapi-tests, worker-tests, spring-boot-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fastapi-tests.result }}" != "success" ]] || \
             [[ "${{ needs.worker-tests.result }}" != "success" ]] || \
             [[ "${{ needs.spring-boot-tests.result }}" != "success" ]]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All tests passed!"
